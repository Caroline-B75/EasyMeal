<%= form_with model: ingredient, class: "ingredient-form", data: { turbo: false } do |f| %>
  <% if ingredient.errors.any? %>
    <div class="form-errors">
      <h3><%= pluralize(ingredient.errors.count, "erreur") %> à corriger :</h3>
      <ul>
        <% ingredient.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="form-group">
    <%= f.label :name, "Nom de l'ingrédient *", class: "form-label" %>
    <%= f.text_field :name, 
        class: "form-input",
        placeholder: "Ex: Tomates",
        required: true %>
  </div>

  <div class="form-group">
    <%= f.label :category, "Rayon *", class: "form-label" %>
    <small class="form-hint">Le rayon où se trouve cet ingrédient en supermarché</small>
    <%= f.select :category,
        Ingredient.categories.map { |k, _v| [Ingredient.human_attribute_name("category.#{k}"), k] },
        { prompt: "Sélectionnez un rayon" },
        class: "form-select",
        required: true %>
  </div>

  <div class="form-group">
    <%= f.label :unit_group, "Groupe d'unités *", class: "form-label" %>
    <small class="form-hint">Type de mesure pour cet ingrédient</small>
    <%= f.select :unit_group,
        Ingredient.unit_groups.map { |k, _v| [Ingredient.human_attribute_name("unit_group.#{k}"), k] },
        { prompt: "Sélectionnez un groupe" },
        class: "form-select",
        required: true,
        data: { action: "change->ingredient-form#updateBaseUnit" } %>
  </div>

  <div class="form-group">
    <%= f.label :base_unit, "Unité de base *", class: "form-label" %>
    <small class="form-hint">Déterminée automatiquement</small>
    <%= f.text_field :base_unit,
        class: "form-input",
        placeholder: "Ex: g, ml, piece, cac",
        readonly: true %>
  </div>

  <div class="form-group">
    <%= f.label :aliases, "Alias (synonymes)", class: "form-label" %>
    <small class="form-hint">Noms alternatifs pour faciliter la recherche</small>
    <%= f.text_field :aliases,
        value: ingredient.aliases.is_a?(Array) ? ingredient.aliases.join(', ') : '',
        class: "form-input",
        placeholder: "Ex: tomate, tomate fraîche (séparés par des virgules)" %>
  </div>

  <div class="form-group">
    <%= f.label :season_months, "Mois de saison", class: "form-label" %>
    <small class="form-hint">Cochez les mois où cet ingrédient est de saison</small>
    <%= hidden_field_tag "ingredient[season_months][]", "" %>
    <div class="months-grid">
      <% (1..12).each do |month| %>
        <label class="month-checkbox">
          <%= check_box_tag "ingredient[season_months][]", 
              month, 
              ingredient.season_months.include?(month),
              id: "ingredient_season_months_#{month}" %>
          <span><%= Date::ABBR_MONTHNAMES[month] %></span>
        </label>
      <% end %>
    </div>
  </div>

  <div class="form-actions">
    <%= f.submit ingredient.new_record? ? "Créer l'ingrédient" : "Mettre à jour", 
        class: "btn btn-primary" %>
    <%= link_to "Annuler", ingredients_path, class: "btn btn-secondary" %>
  </div>
<% end %>

<script>
  // Auto-remplir base_unit selon unit_group sélectionné
  document.addEventListener('turbo:load', function() {
    const unitGroupSelect = document.querySelector('[data-action*="updateBaseUnit"]');
    const baseUnitInput = document.querySelector('#ingredient_base_unit');
    
    if (unitGroupSelect && baseUnitInput) {
      unitGroupSelect.addEventListener('change', function() {
        const unitMap = {
          'mass': 'g',
          'volume': 'ml',
          'count': 'piece',
          'spoon': 'cac'
        };
        baseUnitInput.value = unitMap[this.value] || '';
      });
    }
  });
</script>

<style>
  /* === Charte graphique EasyMeal - Formulaires === */
  
  .ingredient-form {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .form-errors {
    background: #fef2f2;
    border: 2px solid #C8444B;
    border-radius: 12px;
    padding: 1rem;
    margin-bottom: 1rem;
  }

  .form-errors h3 {
    color: #A63940;
    font-size: 1rem;
    margin: 0 0 0.5rem 0;
    font-weight: 600;
  }

  .form-errors ul {
    margin: 0;
    padding-left: 1.5rem;
    color: #A63940;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .form-label {
    font-weight: 600;
    color: #3D3D3D;
    font-size: 1rem;
  }

  .form-input,
  .form-select {
    padding: 0.75rem 1rem;
    border: 2px solid #E8E4DF;
    border-radius: 12px;
    font-size: 1rem;
    background: white;
    color: #3D3D3D;
    transition: all 0.2s;
  }

  .form-input:focus,
  .form-select:focus {
    outline: none;
    border-color: #C8444B;
    box-shadow: 0 0 0 3px rgba(200, 68, 75, 0.1);
  }

  .form-input[readonly] {
    background: #FAF8F5;
    color: #6B6B6B;
  }

  .form-hint {
    font-size: 0.9rem;
    color: #6B6B6B;
    margin-bottom: 0.5rem;
  }

  .months-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
    gap: 0.5rem;
    padding: 0.75rem;
    background: #FAF8F5;
    border-radius: 12px;
  }

  .month-checkbox {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    cursor: pointer;
    border-radius: 8px;
    transition: background 0.2s;
  }

  .month-checkbox:hover {
    background: #E8E4DF;
  }

  .month-checkbox input[type="checkbox"] {
    cursor: pointer;
    accent-color: #C8444B;
  }

  .month-checkbox span {
    font-size: 0.875rem;
    color: #3D3D3D;
  }

  .form-actions {
    display: flex;
    gap: 1rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #E8E4DF;
  }

  /* Boutons réutilisés */
  .btn {
    padding: 0.75rem 1.5rem;
    border-radius: 12px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.2s;
    border: none;
    cursor: pointer;
    font-size: 1rem;
  }

  .btn-primary {
    background: #C8444B;
    color: white;
  }

  .btn-primary:hover {
    background: #A63940;
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(200, 68, 75, 0.3);
  }

  .btn-secondary {
    background: transparent;
    border: 2px solid #E8E4DF;
    color: #4A4A4A;
  }

  .btn-secondary:hover {
    background: #FAF8F5;
    border-color: #C8444B;
    color: #C8444B;
  }

  /* === RESPONSIVE DESIGN === */
  
  /* Mobile (< 768px) */
  @media (max-width: 767px) {
    .ingredient-form {
      gap: 1.25rem;
    }

    .form-label {
      font-size: 0.9375rem;
    }

    .form-input,
    .form-select {
      font-size: 16px; /* Évite le zoom automatique sur iOS */
      padding: 0.875rem 1rem;
    }

    .form-hint {
      font-size: 0.8125rem;
    }

    /* Grille de mois en 3 colonnes sur mobile */
    .months-grid {
      grid-template-columns: repeat(3, 1fr);
      gap: 0.5rem;
      padding: 0.5rem;
    }

    .month-checkbox {
      flex-direction: column;
      gap: 0.25rem;
      padding: 0.5rem 0.25rem;
      text-align: center;
    }

    .month-checkbox span {
      font-size: 0.75rem;
    }

    /* Actions en colonne sur mobile */
    .form-actions {
      flex-direction: column;
      gap: 0.75rem;
    }

    .btn {
      width: 100%;
      text-align: center;
      padding: 0.875rem 1rem;
    }

    .form-errors {
      padding: 0.875rem;
    }

    .form-errors h3 {
      font-size: 0.9375rem;
    }

    .form-errors ul {
      font-size: 0.875rem;
    }
  }

  /* Tablette (768px - 1024px) */
  @media (min-width: 768px) and (max-width: 1024px) {
    .months-grid {
      grid-template-columns: repeat(4, 1fr);
    }
  }

  /* Desktop (> 1024px) */
  @media (min-width: 1025px) {
    .months-grid {
      grid-template-columns: repeat(6, 1fr);
    }
  }

  /* Assurer des zones tactiles suffisantes sur mobile */
  @media (max-width: 767px) {
    .month-checkbox {
      min-height: 44px;
    }

    .btn {
      min-height: 48px;
    }
  }
</style>
